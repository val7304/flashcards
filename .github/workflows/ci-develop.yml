name: CI - Develop

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

permissions:
  contents: read
  security-events: write

jobs:
  build-and-test:
    runs-on: ubuntu-24.04
    env:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:h2:mem:itdb;DB_CLOSE_DELAY=-1
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: 

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654   #v5
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Make mvnw executable
        run: chmod +x mvnw

      - name: Validate formatting with Spotless
        run: ./mvnw spotless:check

      - name: Initialize CodeQL
        uses: github/codeql-action/init@9e907b5e64f6b83e7804b09294d44122997950d6
        with:
          languages: java

      - name: Run Maven clean verify
        run: ./mvnw -B clean verify jacoco:report

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@9e907b5e64f6b83e7804b09294d44122997950d6

      - name: Scan dependencies with Trivy
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: HIGH,CRITICAL

