name: Prod Build, Analyze and Deploy Flashcards App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: flashcardsdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: pswd
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      IMAGE_NAME: flashcards
      IMAGE_TAG: v${{ github.run_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Make scripts and mvnw executable
        run: |
          chmod +x mvnw
          chmod +x ci-scripts/*.sh

      - name: Build with Maven
        run: ./mvnw -B clean verify

      - name: Run Checkstyle
        run: ./mvnw checkstyle:check

      - name: Run SpotBugs
        run: ./mvnw spotbugs:check

      - name: Wait for PostgreSQL
        run: |
          for i in {1..15}; do
            nc -z localhost 5432 && echo "PostgreSQL is up" && break
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Run JUnit tests ++ Jacoco coverage
        run: ./mvnw -B clean test jacoco:report

      - name: Upload JaCoCo report (HTML + XML)
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: Upload JaCoCo XML for SonarCloud
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml
          path: target/site/jacoco/jacoco.xml

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan Maven dependencies with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: HIGH,CRITICAL

      - name: Build application
        run: ci-scripts/build.sh

      - name: Run tests (prod profile)
        run: |
          export SPRING_PROFILES_ACTIVE=prod
          ci-scripts/test.sh

      - name: Debug Docker image reference
        run: echo "Image ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

      - name: Build Docker image
        run: |
          ci-scripts/docker-build.sh "${{ env.IMAGE_NAME }}" "${{ env.IMAGE_TAG }}"

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: table
          vuln-type: 'os,library'
          severity: CRITICAL,HIGH
          exit-code: 0

      - name: Show built image
        run: docker images | grep flashcards

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Push image to Docker Hub
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

  cleanup:
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make mvnw executable
        run: chmod +x mvnw

      - name: Cleanup Maven workspace
        run: ./mvnw clean
